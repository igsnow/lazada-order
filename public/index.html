<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>lazada</title>
    <link rel="shortcut icon" type="image/x-icon" href="lib/images/debug.ico">
    <link rel="stylesheet" href="lib/layui/css/layui.css">
    <link rel="stylesheet" href="lib/css/index.css">
    <script src="lib/layui/layui.js"></script>
    <script src="lib/js/jquery-3.3.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="layui-container headerWrapper">
    <h2 class="header">商品信息</h2>
    <form class="layui-form" action="">
        <div class="layui-form-item">
            <div class="layui-input-block">
                <a class="layui-btn" id="nameBtn">随机获取账号</a>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">刷单次数</label>
            <div class="layui-input-block">
                <input id="numIpt"
                       type="text"
                       name="num"
                       required lay-verify="required" placeholder="请输入次数"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">账号列表</label>
            <div class="layui-input-block">
                <textarea id="accountList" name="accountList" placeholder="请点击随机获取账号按钮"
                          class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品链接</label>
            <div class="layui-input-block">
                <input id="detailUrlIpt"
                       type="text"
                       name="detailUrl" required lay-verify="required"
                       placeholder="请输入商品详情链接"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">SKU</label>
            <div class="layui-input-block">
                <input id="skuIpt"
                       type="text"
                       name="sku" required lay-verify="required"
                       placeholder="请输入SKU"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <a class="layui-btn" lay-submit lay-filter="confirm">开始</a>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>
<div class="layui-container">
    <div class="title">
        <h2 class="header">操作日志</h2>
        <button class="layui-btn">成功数次<span class="layui-badge layui-bg-gray successNum">0</span></button>
    </div>
    <ul id="msg">
        <li id="tip">暂无日志</li>
    </ul>
    <div id="chat">
        <input
                id="ipt"
                type="text"
                placeholder="请输入"
                autocomplete="off"
                class="layui-input"/>
        <button class="layui-btn" id="btn">send</button>
    </div>
</div>
</body>
<script>
    // 账户列表
    var accountList = [];
    $(function () {


        // 账号、密码、链接默认值
        // $('#accountIpt').val('716810918@qq.com');
        // $('#pwdIpt').val('gyj388153@');
        $('#detailUrlIpt').val('https://www.lazada.com.my/products/new-plus-size-s-5xl-floral-bomber-jacket-men-hip-hop-slim-fit-flowers-pilot-bomber-jacket-coat-mens-hooded-jackets-i581532837-s1164964719.html?');
        $('#skuIpt').val(JSON.stringify({
            Color: "White",
            Size: "3XL",
            Quantity: 3
        }));

        layui.use('form', function () {
            let form = layui.form;
            //监听提交
            form.on('submit(confirm)', function (data) {
                layer.msg('请求已发送~');
                let curParamObj = accountList.shift();
                parseAccountList(accountList);

                $.ajax({
                    url: '/user/lazada/order',
                    type: 'POST',
                    data: {
                        account: curParamObj.account,
                        pwd: curParamObj.pwd,
                        detailUrl: data.field.detailUrl,
                        sku: data.field.sku
                    },
                    success: function (res) {
                        if (res.msg === 'success') {
                            layer.msg(res.title);
                        } else {
                            layer.msg(res.title);
                        }
                    },
                    error: function (res) {
                        console.log(res);
                    }
                })
            });
        });

        // 白名单随机获取账号
        $('#nameBtn').click(function () {
            let el = $('#numIpt');
            if (!el.val()) {
                layer.msg('请输入刷单次数！');
                return
            }
            $.ajax({
                url: '/user/lazada/users',
                type: 'GET',
                data: {
                    num: el.val()
                },
                dataType: 'json',
                success: function (res) {
                    if (res.msg === 'success') {
                        accountList = res.data;
                        parseAccountList(accountList)
                    }
                },
                error: function (res) {
                    console.log(res);
                }
            })
        });

        // 日志区域高度自适应
        let maxHeight = $(window).height() - $('.headerWrapper').height() - 290;
        let ulWrapper = document.getElementById('msg');
        ulWrapper.style.maxHeight = maxHeight + 'px';
        ulWrapper.style.overflowY = 'auto';

        // init滚动条滚动至底部
        scrollToBottom();

        const socket = io();
        $('#btn').click(function () {
            let el = $('#ipt');
            if (!el.val()) {
                layer.msg('请输入消息！');
                return
            }
            socket.emit('chatMsg', el.val());
            el.val('');
            return false;
        });

        socket.on('chatMsg', function (data) {
            // 如接收到消息，则隐藏"暂无日志"
            $('#tip').hide();
            $('#msg').append($('<li class="chatMsg">').text(data));
            scrollToBottom()
        });

        // 监听success操作日志
        socket.on('successMsg', function (data) {
            $('#tip').hide();
            $('#msg').append($('<li class="successMsg">').text(data));
            scrollToBottom()
        });

        // 监听error操作日志
        socket.on('errorMsg', function (data) {
            // 如接收到消息，则隐藏"暂无日志"
            $('#tip').hide();
            $('#msg').append($('<li class="errorMsg">').text(data));
            scrollToBottom()
        });

        // 日志框新增数据后自动滚动到底部
        function scrollToBottom() {
            ulWrapper.scrollTop = ulWrapper.scrollHeight;
        }

        // 获取随机账号列表的account值
        function getAccounts(data) {
            let arr = [];
            for (let i = 0; i < data.length; i++) {
                arr.push(data[i].account)
            }
            return arr
        }

        // 整理账户列表数据
        function parseAccountList(data) {
            let accounts = getAccounts(data);
            let str = accounts.join(';');
            $('#accountList').val(str)
        }
    })
</script>
</html>
